{% extends "base.html" %}

{% block title %}Upload Invoice{% endblock %}
{% block page_title %}Upload Invoices{% endblock %}

{% block content %}
<style>
    @keyframes blob-move {
        0% {
            transform: translate(0px, 0px) scale(1);
        }

        33% {
            transform: translate(30px, -50px) scale(1.1);
        }

        66% {
            transform: translate(-20px, 20px) scale(0.9);
        }

        100% {
            transform: translate(0px, 0px) scale(1);
        }
    }

    .animate-blob {
        animation: blob-move 8s infinite ease-in-out;
    }

    input:required:invalid:not(:focus),
    textarea:required:invalid:not(:focus) {
        border-color: #ef4444;
    }


</style>

<div class="relative min-h-screen -m-4 md:-m-6 p-4 md:p-6 overflow-hidden">

    <div class="absolute top-0 left-0 w-full h-full">
        <div
            class="absolute top-0 -left-16 w-72 h-72 bg-purple-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob">
        </div>
        <div class="absolute top-0 -right-16 w-72 h-72 bg-sky-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
            style="animation-delay: 2s;"></div>
        <div class="absolute -bottom-16 left-20 w-72 h-72 bg-indigo-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
            style="animation-delay: 4s;"></div>
    </div>

    <div class="relative max-w-7xl mx-auto">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="p-4 mb-4 text-sm rounded-lg 
            {% if category == 'error' %} bg-red-100 text-red-700 rounded-lg border border-red-300
            {% elif category == 'success' %}  bg-green-100 text-green-700 rounded-lg border border-green-300
            {% elif category == 'warning' %}  bg-blue-100 text-blue-700 rounded-lg border border-blue-300
            {% else %} bg-blue-100 text-blue-700 rounded-lg border border-blue-300
            {% endif %}" role="alert">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="flex flex-col lg:flex-row gap-8">

            <div class="lg:w-1/3 order-1 lg:order-2">
                <div class="bg-white/70 backdrop-blur-sm p-6 rounded-xl border border-slate-200">
                    <div id="guidelines-toggle"
                        class="flex justify-between items-center cursor-pointer lg:cursor-default">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                            </svg>
                            <h3 class="text-lg font-semibold text-slate-800">Guidelines</h3>
                        </div>
                        <div class="lg:hidden">
                            <svg id="guidelines-chevron" class="w-5 h-5 text-gray-500 transition-transform" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <hr class="my-4 border-slate-200">

                    <ul id="guidelines-list" class="space-y-4 text-slate-600 hidden lg:block">
                        <li class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-emerald-500 flex-shrink-0 mt-0.5"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Upload in <strong class="font-semibold text-slate-700">PDF, PNG, JPG, or JPEG</strong>
                                format.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-emerald-500 flex-shrink-0 mt-0.5"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Maximum file size is <strong class="font-semibold text-slate-700">5MB</strong>.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-emerald-500 flex-shrink-0 mt-0.5"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Ensure the invoice copy is <strong class="font-semibold text-slate-700">clear and
                                    legible</strong>.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-emerald-500 flex-shrink-0 mt-0.5"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>The <strong class="font-semibold text-slate-700">Invoice Number</strong> must match
                                the
                                document.</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="lg:w-2/3 order-2 lg:order-1">
                <div class="bg-white/70 backdrop-blur-sm p-6 rounded-xl border border-slate-200 min-h-[400px]">

                    {% if is_registered %}

                    <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b border-slate-200 pb-3">Submit a New
                        Invoice</h2>
                    <form id="invoice-upload-form" method="POST" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                {{ form.invoice_number.label(class="block mb-2 text-sm font-medium text-slate-700") }}
                                {{ form.invoice_number(class="w-full px-4 py-3 rounded-lg bg-slate-50 border
                                border-slate-300 focus:outline-none focus:border-black focus:ring-1 focus:ring-black",
                                placeholder="e.g., INV-2025-001", required=true) }}
                                {% for error in form.invoice_number.errors %}<p class="text-red-500 text-xs mt-1">{{
                                    error }}</p>{% endfor %}
                            </div>
                            <div>
                                {{ form.po_number.label(class="block mb-2 text-sm font-medium text-slate-700") }}
                                {{ form.po_number(class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-300
                                focus:outline-none focus:border-black focus:ring-1 focus:ring-black", 
                                placeholder="e.g., PO-2025-001", required=true) }}
                                {% for error in form.po_number.errors %}<p class="text-red-500 text-xs mt-1">{{ error }}
                                </p>{%endfor %}
                            </div>
                            <div class="md:col-span-2">
                                {{ form.invoice_amount.label(class="block mb-2 text-sm font-medium text-slate-700") }}
                                {{ form.invoice_amount(class="w-full px-4 py-3 rounded-lg bg-slate-50 border
                                border-slate-300 focus:outline-none focus:border-black focus:ring-1 focus:ring-black",
                                placeholder="e.g., 50000.00", required=true) }}
                                {% for error in form.invoice_amount.errors %}<p class="text-red-500 text-xs mt-1">{{
                                    error }}</p>{% endfor %}
                            </div>
                            <div class="md:col-span-2">
                                {{ form.description.label(class="block mb-2 text-sm font-medium text-slate-700") }}
                                {{ form.description(rows="3", class="w-full px-4 py-3 rounded-lg bg-slate-50 border
                                border-slate-300 focus:outline-none focus:border-black focus:ring-1
                                focus:ring-black",
                                placeholder="e.g., Supply of cement for Block-A") }}
                                {% for error in form.description.errors %}<p class="text-red-500 text-xs mt-1">{{ error
                                    }}</p>{%endfor %}
                            </div>
                            <div class="md:col-span-2">
                                {{ form.invoice_file.label(class="block mb-2 text-sm font-medium text-slate-700") }}
                                <div id="file-drop-zone"
                                    class="mt-1 flex justify-center items-center px-6 pt-5 pb-6 border-2 border-red-500 border-dashed rounded-lg cursor-pointer transition-colors duration-200 hover:border-black">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48" aria-hidden="true">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="flex text-sm text-slate-600">
                                            <p class="pl-1">Choose or Drag & Drop your file.</p>
                                        </div>
                                        <p class="text-xs text-slate-500">PDF, PNG, JPG or JPEG up to 5MB</p>
                                    </div>
                                </div>
                                {{ form.invoice_file(class="hidden", id="invoice_file_input", required=true,
                                accept=".pdf,.png,.jpg,.jpeg") }}

                                {% for error in form.invoice_file.errors %}<p class="text-red-500 text-xs mt-1">{{ error
                                    }}</p>
                                {% endfor %}

                                <div id="file-preview-container" class="mt-4 hidden border p-2 rounded-lg bg-gray-50">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button type="submit"
                                class="inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">
                                Upload Invoice
                            </button>
                        </div>
                    </form>

                    {% else %}

                    <div class="flex flex-col p-8 h-full">

                        <div class="flex items-center gap-3">
                            <svg class="h-10 w-10 text-indigo-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                            </svg>
                            <h3 class="text-2xl font-semibold text-slate-800">Complete Your Registration</h3>
                        </div>

                        <p class="mt-4 text-slate-600">
                            To upload invoices, please register as a vendor first. Just choose your vendor type below to
                            get started!
                        </p>

                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">

                            <a href="{{ url_for('main.vendor_form_material') }}"
                                class="group block p-5 bg-white/50 hover:bg-white border border-slate-200 hover:border-indigo-400 rounded-lg transition-all shadow-sm hover:shadow-lg">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="p-2 bg-slate-100 rounded-full group-hover:bg-indigo-500 transition-colors">
                                        <svg class="h-6 w-6 text-slate-600 group-hover:text-white transition-colors"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M8.25 18.75a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 0 1-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 0 0-3.213-9.193 2.056 2.056 0 0 0-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 0 0-10.026 0 1.106 1.106 0 0 0-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
                                        </svg>

                                    </div>
                                    <h4 class="text-lg font-semibold text-slate-900">Material Vendor</h4>
                                </div>
                                <p class="mt-3 text-sm text-slate-600">Suppliers of raw materials and goods.</p>
                            </a>

                            <a href="{{ url_for('main.vendor_form_work') }}"
                                class="group block p-5 bg-white/50 hover:bg-white border border-slate-200 hover:border-indigo-400 rounded-lg transition-all shadow-sm hover:shadow-lg">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="p-2 bg-slate-100 rounded-full group-hover:bg-indigo-500 transition-colors">
                                        <svg class="h-6 w-6 text-slate-600 group-hover:text-white transition-colors"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                                        </svg>

                                    </div>
                                    <h4 class="text-lg font-semibold text-slate-900">Work Vendor</h4>
                                </div>
                                <p class="mt-3 text-sm text-slate-600">Contractors, laborers, and service providers.</p>
                            </a>

                        </div>

                        <div class="mt-6 pt-4 border-t border-slate-200">
                            <p class="text-sm text-slate-500">
                                If you have already submitted a form, it may still be "Under Review".
                                <br class="hidden sm:block">
                                Please check your <a href="{{ url_for('main.your_profile') }}"
                                    class="text-indigo-600 underline font-medium hover:text-indigo-800">profile
                                    status</a>.
                            </p>
                        </div>

                    </div>

                    {% endif %}
                </div>
            </div>
        </div>


        <div class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-xl border border-slate-200 mt-8">
            <div class="flex justify-between items-center border-b border-slate-200 pb-3 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Recent Invoice History</h2>
                {% if invoices %}
                <a href="/all-invoices"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors">
                    View Full History &rarr;
                </a>
                {% endif %}
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left table-fixed">
                    <thead class="border-b border-slate-300 hidden md:table-header-group">
                        <tr>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Invoice No.</th>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Submission Date</th>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Description</th>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Amount</th>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Status</th>
                            <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Files</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 md:divide-y-0">
                        {% if invoices %}
                        {% for invoice in invoices[:5] %}

                        <tr
                            class="block md:table-row mb-4 md:mb-0 rounded-lg md:rounded-none shadow-md md:shadow-none border md:border-none even:bg-slate-50/50">

                            {# Invoice No. #}
                            <td
                                class="block md:table-cell py-3 px-4 font-medium text-black border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Invoice No.: </span>
                                <div class="inline md:block truncate" title="{{ invoice.invoice_number }}">
                                    {{ invoice.invoice_number }}
                                </div>
                            </td>

                            {# Submission Date #}
                            <td
                                class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Submission Date: </span>
                                <div class="inline md:block truncate"
                                    title="{{ invoice.submission_date.strftime('%Y-%m-%d') }}">
                                    {{ invoice.submission_date.strftime('%Y-%m-%d') }}
                                </div>
                            </td>

                            {# Description #}
                            <td
                                class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Description: </span>
                                <div class="inline md:block" title="{{ invoice.description }}">
                                    {{ invoice.description }}
                                </div>
                            </td>

                            {# Amount #}
                            <td
                                class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Amount: </span>
                                <div class="inline md:block truncate"
                                    title="₹ {{ '%.2f'|format(invoice.invoice_amount) }}">
                                    ₹ {{ "%.2f"|format(invoice.invoice_amount) }}
                                </div>
                            </td>

                            {# Status #}
                            <td
                                class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Status: </span>
                                <span class="inline-block rounded-full px-3 py-1 text-xs font-semibold
                                {% if invoice.status == 'Approved' %} text-green-700 bg-green-100
                                {% elif invoice.status == 'Rejected' %} text-red-700 bg-red-100
                                {% else %} text-yellow-700 bg-yellow-100 {% endif %}">
                                    {{ invoice.status }}
                                </span>
                            </td>

                            {# Files #}
                            <td
                                class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                                <span class="font-semibold text-slate-600 md:hidden">Files: </span>
                                {% if invoice.file_path %}
                                <a href="{{ url_for('main.download_invoice', filename=invoice.file_path) }}"
                                    target="_blank"
                                    class="text-indigo-600 hover:underline hover:text-indigo-800 font-medium text-sm">
                                    View Invoice
                                </a>
                                {% endif %}
                            </td>

                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="py-8 px-4 text-center text-slate-500">You have not uploaded any
                                invoices yet.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-4 sm:mx-auto p-5 border sm:w-full sm:max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Upload Error</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="error-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-modal-btn"
                            class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- NEW: Guidelines Toggle Logic ---
        const guidelinesToggle = document.getElementById('guidelines-toggle');
        const guidelinesList = document.getElementById('guidelines-list');
        const guidelinesChevron = document.getElementById('guidelines-chevron');

        guidelinesToggle.addEventListener('click', () => {

            // This ensures the click only works on smaller screens where the list is collapsible

            if (window.innerWidth < 1024) {
                guidelinesList.classList.toggle('hidden');
                guidelinesChevron.classList.toggle('rotate-180');
            }
        });


        // If the form doesn't exist (because user is not registered),
        const form = document.getElementById('invoice-upload-form');

        // stop running this script to avoid errors.
        if (!form) {
            return;
        }

        const dropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('invoice_file_input');

        // NEW: Preview container element
        const previewContainer = document.getElementById('file-preview-container');

        // Modal elements
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeModalBtn = document.getElementById('close-modal-btn');

        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        const ALLOWED_FILE_TYPES = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];

        const initialDropZoneHTML = dropZone.innerHTML;


        // --- Modal Logic ---
        const showModal = (message) => {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        };

        const hideModal = () => {
            errorModal.classList.add('hidden');
        };

        closeModalBtn.addEventListener('click', hideModal);
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                hideModal();
            }
        });

        // --- NEW: Function to render file preview ---
        const renderPreview = (file) => {
            const reader = new FileReader();

            reader.onload = (e) => {
                previewContainer.innerHTML = '';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'max-h-60 w-auto mx-auto rounded-md shadow-sm';
                    img.alt = 'File preview';
                    previewContainer.appendChild(img);
                } else if (file.type === 'application/pdf') {
                    const embed = document.createElement('embed');
                    embed.src = e.target.result;
                    embed.type = 'application/pdf';
                    embed.className = 'w-full h-80 rounded-md';
                    previewContainer.appendChild(embed);
                }

                previewContainer.classList.remove('hidden');
            };

            reader.readAsDataURL(file);
        };

        const handleFile = (file) => {
            if (!file) return;

            // Reset border color in case it was red
            dropZone.classList.remove('border-red-500');
            dropZone.classList.add('border-slate-300');


            if (file.size > MAX_FILE_SIZE) {
                showModal('File size exceeds 5MB. Please upload a smaller file.');
                resetFileInput();
                return;
            }

            if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                showModal('Invalid file format. Please upload a PDF, PNG, JPG or JPEG file.');
                resetFileInput();
                return;
            }

            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            // --- UI Change for Upload Success ---
            dropZone.classList.remove('border-slate-300', 'border-dashed', 'border-indigo-400', 'bg-blue-50');
            dropZone.classList.add('border-green-500', 'bg-green-50');
            dropZone.innerHTML = `
                <div class="space-y-1 text-center py-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-sm text-gray-800 font-medium truncate px-2" title="${file.name}">${file.name}</p>
                    <button type="button" id="remove-file-btn" class="text-xs text-red-600 hover:underline">Remove file</button>
                </div>
            `;

            // NEW: Render the preview
            renderPreview(file);

            document.getElementById('remove-file-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                resetFileInput();
            });
        };

        const resetFileInput = () => {
            fileInput.value = '';
            dropZone.classList.remove('border-green-500', 'bg-green-50', 'border-red-500');
            dropZone.classList.add('border-slate-300', 'border-dashed');
            dropZone.innerHTML = initialDropZoneHTML;

            // NEW: Clear and hide the preview container
            previewContainer.innerHTML = '';
            previewContainer.classList.add('hidden');
        };

        // --- Event Listeners for Drag and Drop ---
        dropZone.addEventListener('click', () => {
            if (!fileInput.files || fileInput.files.length === 0) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFile(fileInput.files[0]);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!fileInput.files || fileInput.files.length === 0) {
                dropZone.classList.add('border-indigo-400', 'bg-indigo-50/80');
            }
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-400', 'bg-indigo-50/80');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-400', 'bg-indigo-50/80');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
    });

</script>
{% endblock %}