{% extends "base.html" %}

{% block title %}Help & Support{% endblock %}
{% block page_title %}Help & Support Center{% endblock %}

{% block content %}
<style>
   @keyframes blob-move {
      0% {
         transform: translate(0px, 0px) scale(1);
      }

      33% {
         transform: translate(30px, -50px) scale(1.1);
      }

      66% {
         transform: translate(-20px, 20px) scale(0.9);
      }

      100% {
         transform: translate(0px, 0px) scale(1);
      }
   }

   .animate-blob {
      animation: blob-move 8s infinite ease-in-out;
   }

   .error-text {
      color: #dc2626;
      font-size: 0.75rem;
      margin-top: 0.25rem;
   }
</style>

<div class="relative min-h-screen -m-4 md:-m-6 p-4 md:p-6 overflow-hidden">

   <!-- Background darker decorative blobs -->
   <!-- <div class="absolute top-0 left-0 w-full h-full">
      <div
         class="absolute top-0 -left-16 w-72 h-72 bg-green-600 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob">
      </div>
      <div
         class="absolute top-0 -right-16 w-72 h-72 bg-cyan-600 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
         style="animation-delay: 2s;"></div>
      <div
         class="absolute -bottom-16 left-20 w-72 h-72 bg-orange-300 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
         style="animation-delay: 4s;"></div>
   </div> -->

   <div class="absolute top-0 left-0 w-full h-full z-0">
      <div
         class="absolute top-0 -left-16 w-72 h-72 bg-purple-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob">
      </div>
      <div
         class="absolute top-0 -right-16 w-72 h-72 bg-sky-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
         style="animation-delay: 2s;"></div>
      <div
         class="absolute -bottom-16 left-20 w-72 h-72 bg-indigo-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"
         style="animation-delay: 4s;"></div>
   </div>

   <div class="relative max-w-7xl mx-auto space-y-8">

      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div
         class="p-4 mb-4 text-sm rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}"
         role="alert">
         {{ message }}
      </div>
      {% endfor %}
      {% endif %}
      {% endwith %}

      <!-- FAQ Section -->
      <div class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-xl border border-slate-200">
         <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b border-slate-200 pb-3">Frequently Asked Questions</h2>
         <div class="space-y-4" id="faq-accordion">
            <div class="accordion-item border-b border-slate-200 pb-4">
               <button
                  class="accordion-btn flex items-center justify-between w-full text-left font-semibold text-slate-800 hover:text-indigo-600 transition-colors">
                  <span>What is the typical payment cycle?</span>
                  <svg class="accordion-icon w-6 h-6 shrink-0 transform rotate-180" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
               </button>
               <div class="accordion-content mt-3 text-slate-700">
                  <p>Our standard payment cycle is Net-30, meaning payments are processed 30 days after the invoice is
                     officially approved by our accounts department.</p>
               </div>
            </div>
            <div class="accordion-item border-b border-slate-200 pb-4">
               <button
                  class="accordion-btn flex items-center justify-between w-full text-left font-semibold text-slate-800 hover:text-indigo-600 transition-colors">
                  <span>How do I correct a rejected invoice?</span>
                  <svg class="accordion-icon w-6 h-6 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
               </button>
               <div class="accordion-content mt-3 text-slate-700 hidden">
                  <p>If an invoice is rejected, you will receive a notification with the reason for rejection. Please
                     correct the specified issue and re-upload the invoice with a new version number (e.g.,
                     INV-001-RevA) on the 'Upload Invoices' page.</p>
               </div>
            </div>
            <div class="accordion-item border-b border-slate-200 pb-4">
               <button
                  class="accordion-btn flex items-center justify-between w-full text-left font-semibold text-slate-800 hover:text-indigo-600 transition-colors">
                  <span>What file formats are accepted for invoices?</span>
                  <svg class="accordion-icon w-6 h-6 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
               </button>
               <div class="accordion-content mt-3 text-slate-700 hidden">
                  <p>We accept invoices in PDF, PNG, JPG, or JPEG formats. Please ensure the file size is under 5MB.</p>
               </div>
            </div>
            <div class="accordion-item border-b border-slate-200 pb-4">
               <button
                  class="accordion-btn flex items-center justify-between w-full text-left font-semibold text-slate-800 hover:text-indigo-600 transition-colors">
                  <span>How can I check the status of my submitted invoice?</span>
                  <svg class="accordion-icon w-6 h-6 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
               </button>
               <div class="accordion-content mt-3 text-slate-700 hidden">
                  <p>You can track the status of all your invoices (e.g., 'In Review', 'Approved', 'Rejected', 'Paid')
                     directly from your main dashboard under the 'Recent Activity' section or on the 'All Invoices'
                     page.</p>
               </div>
            </div>
            <div class="accordion-item pb-4">
               <button
                  class="accordion-btn flex items-center justify-between w-full text-left font-semibold text-slate-800 hover:text-indigo-600 transition-colors">
                  <span>Who do I contact for payment-related queries?</span>
                  <svg class="accordion-icon w-6 h-6 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
               </button>
               <div class="accordion-content mt-3 text-slate-700 hidden">
                  <p>For any queries regarding approved invoices or processed payments, please contact our accounts
                     department directly at <a href="mailto:accounts@glbe.com"
                        class="text-indigo-600 font-medium hover:underline">accounts@glbe.com</a>.</p>
               </div>
            </div>
         </div>
      </div>

      <!-- Support Contact Info -->
      <div
         class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-xl border border-slate-200 flex flex-col justify-center">
         <h2 class="text-2xl font-bold text-slate-800 mb-4">Can't Find Your Answer?</h2>
         <p class="text-slate-700 text-lg mb-6">
            If the FAQs didn't resolve your issue, our support team is here to help. Please describe your problem in
            detail using the form below, and we'll get back to you within 24 business hours.
         </p>
         <p class="text-slate-600">
            For direct payment queries, you can also reach us at:
            <a href="mailto:accounts@glbe.com"
               class="text-indigo-600 font-semibold hover:underline">accounts@glbe.com</a>
         </p>
      </div>

      <!-- Raise a Ticket Section -->
      <div class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-xl border border-slate-200">
         <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b border-slate-200 pb-3">Raise a Ticket</h2>
         <form action="{{ url_for('main.help_support') }}" method="POST" novalidate class="space-y-6">
            {{ form.hidden_tag() }}

            <div>
               {{ form.category.label(class="block text-sm font-medium text-slate-700 mb-2") }}
               {{ form.category(class="w-full px-4 py-3 rounded-lg bg-white/50 border border-slate-300
               focus:outline-none focus:ring-1 focus:ring-black focus:border-black", id="category") }}
               {% for error in form.category.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
            </div>

            <div id="invoice-no-container" class="hidden transition-all duration-300">
               {{ form.invoice_no.label(class="block text-sm font-medium text-slate-700 mb-2") }}
               {{ form.invoice_no(class="w-full px-4 py-3 rounded-lg bg-white/50 border border-slate-300
               focus:outline-none focus:ring-1 focus:ring-black focus:border-black", id="invoice-no", placeholder="e.g., INV-088") }}
               <p class="text-xs text-red-500 mt-1">Please enter the correct Invoice No. for faster resolution.</p>
               {% for error in form.invoice_no.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
            </div>

            <div>
               {{ form.subject.label(class="block text-sm font-medium text-slate-700 mb-2") }}
               {{ form.subject(class="w-full px-4 py-3 rounded-lg bg-white/50 border border-slate-300 focus:outline-none
               focus:ring-1 focus:ring-black focus:border-black", placeholder="e.g., Invoice Payment Delay") }}
               {% for error in form.subject.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
            </div>

            <div>
               {{ form.message.label(class="block text-sm font-medium text-slate-700 mb-2") }}
               {{ form.message(rows="5", class="w-full px-4 py-3 rounded-lg bg-white/50 border border-slate-300
               focus:outline-none focus:ring-1 focus:ring-black focus:border-black", placeholder="Please describe your issue in detail...") }}
               {% for error in form.message.errors %}<span class="error-text">{{ error }}</span>{% endfor %}
            </div>

            <div class="text-right pt-2">
               {{ form.submit(class="inline-flex justify-center rounded-lg border border-transparent bg-red-600 py-3
               px-8 font-semibold text-white shadow-sm hover:bg-red-700 transition-colors cursor-pointer") }}
            </div>
         </form>
      </div>

      <!-- Ticket History Section -->
      <div class="bg-white/70 backdrop-blur-sm p-6 md:p-8 rounded-xl border border-slate-200">
         <h2 class="text-2xl font-bold text-slate-800 mb-6">Ticket History</h2>
         <div class="overflow-x-auto">
            <table class="w-full text-left table-fixed">
               <thead class="border-b border-slate-300 hidden md:table-header-group">
                  <tr>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Ticket ID</th>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Category</th>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Invoice No.</th>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Subject</th>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Status</th>
                     <th class="py-3 px-4 font-semibold text-slate-600 whitespace-nowrap">Submitted</th>
                  </tr>
               </thead>
               <tbody class="divide-y divide-slate-200 md:divide-y-0">
                  {% if tickets %}
                  {% for ticket in tickets %}

                  <tr
                     class="block md:table-row mb-4 md:mb-0 rounded-lg md:rounded-none shadow-md md:shadow-none border md:border-none even:bg-slate-50/50">

                     {# Ticket ID #}
                     <td
                        class="block md:table-cell py-3 px-4 font-medium text-black border-b md:border-b-0 last:border-b-0">

                        <span class="font-semibold text-slate-600 md:hidden">Ticket ID: </span>
                        <div class="inline md:block truncate" title="{{ ticket.id }}">
                           {{ ticket.id }}
                        </div>
                     </td>

                     {# Category #}
                     <td class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                        <span class="font-semibold text-slate-600 md:hidden">Category: </span>
                        <div class="inline md:block truncate" title="{{ ticket.category }}">
                           {{ ticket.category }}
                        </div>
                     </td>

                     {# Invoice No. #}
                     <td class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                        <span class="font-semibold text-slate-600 md:hidden">Invoice No.: </span>
                        {{ ticket.invoice_no | default('N/A', true) }}
                     </td>

                     {# Subject #}
                     <td class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                        <span class="font-semibold text-slate-600 md:hidden">Subject: </span>
                        <div class="inline md:block" title="{{ ticket.subject }}">
                           {{ ticket.subject }}
                        </div>
                     </td>

                     {# Status #}
                     <td class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                        <span class="font-semibold text-slate-600 md:hidden">Status: </span>
                        <span class="inline-block rounded-full px-3 py-1 text-xs font-semibold
                              {% if ticket.status == TicketStatus.OPEN %} text-blue-800 bg-blue-100
                              {% elif ticket.status == TicketStatus.IN_PROGRESS %} text-yellow-800 bg-yellow-100
                              {% elif ticket.status == TicketStatus.CLOSED %} text-green-800 bg-green-100
                              {% else %} text-gray-800 bg-gray-100 {% endif %}">
                           {{ ticket.status.value }}
                        </span>
                     </td>

                     {# Submitted #}
                     <td class="block md:table-cell py-3 px-4 text-slate-700 border-b md:border-b-0 last:border-b-0">
                        <span class="font-semibold text-slate-600 md:hidden">Submitted: </span>
                        {{ ticket.created_at.strftime('%Y-%m-%d') }}
                     </td>

                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                     {# This now looks good on both mobile and desktop #}
                     <td colspan="6" class="py-8 px-4 text-center text-slate-500">You haven't submitted any support
                        tickets yet.</td>
                  </tr>
                  {% endif %}
               </tbody>
            </table>
         </div>
      </div>

   </div>
</div>

<script>
   document.addEventListener('DOMContentLoaded', function () {
      
      // --- Accordion Logic ---
      const accordion = document.getElementById('faq-accordion');
      if (accordion) {
         const accordionButtons = accordion.querySelectorAll('.accordion-btn');
         accordionButtons.forEach(button => {
            button.addEventListener('click', () => {
               const content = button.nextElementSibling;
               const icon = button.querySelector('.accordion-icon');
               content.classList.toggle('hidden');
               icon.classList.toggle('rotate-180');
            });
         });
      }

      // --- Ticket Form Logic (handles conditional Invoice No.) ---
      const categorySelect = document.getElementById('category');
      const invoiceNoContainer = document.getElementById('invoice-no-container');
      const invoiceNoInput = document.getElementById('invoice-no');

      if (categorySelect && invoiceNoContainer && invoiceNoInput) {
         const checkCategory = () => {
            const selectedValue = categorySelect.value;
            if (selectedValue === 'Payment Query' || selectedValue === 'Invoice Rejection') {
               invoiceNoContainer.classList.remove('hidden');
               invoiceNoInput.setAttribute('required', 'required');
            } else {
               invoiceNoContainer.classList.add('hidden');
               invoiceNoInput.removeAttribute('required');
               const errorSpan = invoiceNoInput.nextElementSibling;
               if (errorSpan && errorSpan.classList.contains('error-text')) {
                  errorSpan.textContent = '';
               }
               if (!invoiceNoInput.validity.valid) {
                  invoiceNoInput.setCustomValidity('');
               }
            }
         }
         checkCategory();
         categorySelect.addEventListener('change', checkCategory);
      }
   });
</script>
{% endblock %}